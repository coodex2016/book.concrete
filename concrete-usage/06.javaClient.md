# Java Client

截止到目前，我们看到的都是通过`concrete-support-jsr339`发布服务，使用`swagger`调试服务。在本节，我们看看如果使用Java Client来调用服务。

## 开启调试信息

新建一个`concrete.yml`文件如下：

```yml
jaxrs:
  logger:
    level:
      # 可选值为TRACE,DEBUG,INFO,WARN,ERROR,不建议使用WARN以及ERROR级别
      # 可选值以外则表示不输出
      server: info #默认不开启，生产环境不建议开启
      client: info #默认DEBUG
```

> #### Note::
>
> Profile `cocnrete` 在默认的Configuration下，在`concrete`工具链中可以进行有很多配置，后续单独说明

## 调用Jaxrs发布的服务

我们先约定，在demo-boot的测试作用域里调用。

- 增加依赖，说明已经备注上了

```xml
        <!-- 调用jaxrs发布的concrete服务 -->
        <dependency>
            <groupId>org.coodex</groupId>
            <artifactId>concrete-jaxrs-client</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- 使用jersey-client作为jaxrs实现 -->
        <dependency>
            <groupId>org.glassfish.jersey.core</groupId>
            <artifactId>jersey-client</artifactId>
            <scope>test</scope>
        </dependency>
```

- 最简单的方式

```java
package org.coodex.concrete.demo.client;

import org.coodex.concrete.Client;
import org.coodex.concrete.demo.api.SubjoinExampleService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class JaxRSClientDemo1 {
    private final static Logger log = LoggerFactory.getLogger(JaxRSClientDemo1.class);

    public static void main(String[] args) {
        log.info("restful service invoked: {}",
                Client.getInstance(SubjoinExampleService.class, "jaxrs").add(11, 12));
    }
}
```

说明一下，这种方式依赖配置信息，`concrete`默认的配置信息从[Profile](../coodex-utilities/profile.md)中读取，所以我们还要建一个client.jaxrs的Profile，优先使用yaml文件

client.jaxrs.yml

```yml
location: "http://localhost:8080/jaxrs"
```

> #### Note::
>
> concrete-client在使用配置，命名空间为: client, _moduleName_。详见[Configuration](../coodex-utilities/config.md)

ok，server端跑起来，然后跑client，大概能看到的信息如下：

server端：

```txt
2019-08-06 13:30:02.142  INFO 19312 --- [nio-8080-exec-6] o.c.concrete.jaxrs.logging.ServerLogger  : 3 * Server has received a request on thread http-nio-8080-exec-6
3 > POST http://localhost:8080/jaxrs/SubjoinExample/add
3 > accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
3 > accept-language: zh-CN
3 > connection: keep-alive
3 > content-length: 17
3 > content-type: application/json;charset=UTF-8
3 > host: localhost:8080
3 > user-agent: Jersey/2.27 (HttpUrlConnection 1.8.0_202)
3 > x-client-provider: cocnrete-jaxrs-client 0.4.0-SNAPSHOT
{"x1":11,"x2":12}

2019-08-06 13:30:02.521  INFO 19312 --- [vice.executor-3] o.c.concrete.jaxrs.logging.ServerLogger  : 3 * Server responded with a response on thread service.executor-3
3 < 200
3 < CONCRETE-WARNINGS: %5B%7B%22code%22%3A105001%2C%22message%22%3A%2211+%2B+12+%E5%A4%AA%E9%9A%BE%E4%BA%86+%3E_%3C+%28demoErrorCodes%29%22%7D%5D[decoded value:[{"code":105001,"message":"11 + 12 太难了 >_< (demoErrorCodes)"}]]
3 < Content-Type: application/json;charset=UTF-8
23
```

client端

```txt
13:30:02.136 [main] INFO org.coodex.concrete.jaxrs.logging.ClientLogger - 1 * Sending client request on thread main
1 > POST http://localhost:8080/jaxrs/SubjoinExample/add
1 > Accept-Language: zh-CN
1 > Content-Type: application/json;charset=UTF-8
1 > X-CLIENT-PROVIDER: cocnrete-jaxrs-client 0.4.0-SNAPSHOT
{"x1":11,"x2":12}

13:30:02.542 [main] INFO org.coodex.concrete.jaxrs.logging.ClientLogger - 1 * Client response received on thread main
1 < 200
1 < CONCRETE-WARNINGS: %5B%7B%22code%22%3A105001%2C%22message%22%3A%2211+%2B+12+%E5%A4%AA%E9%9A%BE%E4%BA%86+%3E_%3C+%28demoErrorCodes%29%22%7D%5D[decoded value:[{"code":105001,"message":"11 + 12 太难了 >_< (demoErrorCodes)"}]]
1 < Content-Length: 2
1 < Content-Type: application/json;charset=UTF-8
1 < Date: Tue, 06 Aug 2019 05:30:02 GMT
23

13:30:02.603 [main] INFO org.coodex.concrete.demo.client.JaxRSClientDemo1 - restful service invoked: 23
```

我们切换一下client端运行的语言环境: java 参数增加 -Duser.language=en -Duser.region=US

```txt
13:40:13.290 [main] INFO org.coodex.concrete.jaxrs.logging.ClientLogger - 1 * Sending client request on thread main
1 > POST http://localhost:8080/jaxrs/SubjoinExample/add
1 > Accept-Language: en-US
1 > Content-Type: application/json;charset=UTF-8
1 > X-CLIENT-PROVIDER: cocnrete-jaxrs-client 0.4.0-SNAPSHOT
{"x1":11,"x2":12}

13:40:13.428 [main] INFO org.coodex.concrete.jaxrs.logging.ClientLogger - 1 * Client response received on thread main
1 < 200
1 < CONCRETE-WARNINGS: %5B%7B%22code%22%3A105001%2C%22message%22%3A%2211+%2B+12+is+too+hard+%3E_%3C+%28demoErrorCodes%29%22%7D%5D[decoded value:[{"code":105001,"message":"11 + 12 is too hard >_< (demoErrorCodes)"}]]
1 < Content-Length: 2
1 < Content-Type: application/json;charset=UTF-8
1 < Date: Tue, 06 Aug 2019 05:40:13 GMT
23

13:40:13.478 [main] INFO org.coodex.concrete.demo.client.JaxRSClientDemo1 - restful service invoked: 23
```

## 使用Desination来调用

```java
package org.coodex.concrete.demo.client;

import org.coodex.concrete.Client;
import org.coodex.concrete.client.jaxrs.JaxRSDestination;
import org.coodex.concrete.demo.api.SubjoinExampleService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class JaxRSClientDemo2 {
    private final static Logger log = LoggerFactory.getLogger(JaxRSClientDemo2.class);

    public static void main(String[] args) {
        JaxRSDestination destination = new JaxRSDestination();
        destination.setLocation("http://localhost:8080/jaxrs");
        log.info("restful service invoked: {}",
                Client.getInstance(SubjoinExampleService.class, destination).add(11, 12));
    }
}
```

这种方式下，我们可以动态构建调用目标信息，减少外部配置。比方说，我们的系统可能需要向多个concrete服务节点推送信息，而且数量可能增加，那么，我们可以通过数据库管理目标节点信息，使用这种方式调用目标节点的数据服务。
